#
# GitHub Actions Workflow to build NGINX packages for Ubuntu.
# This approach uses dynamic linking against the system's libraries for better
# integration, smaller package size, and easier security patch management via `apt`.
#

name: Build and Release NGINX with ACME Module Package

on:
  workflow_dispatch:
    inputs:
      nginx_version:
        description: 'Optional: Specify an NGINX version to build (e.g., 1.28.0)'
        required: false
        default: ''
  schedule:
    - cron: '30 5 * * *'
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  # This job checks if a new version of NGINX is available or if a manual
  # build has been triggered. It acts as a gatekeeper for the build jobs.
  check-for-new-version:
    name: Check for New NGINX Stable Version
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check_versions.outputs.should_build }}
      version: ${{ steps.check_versions.outputs.version }}
    steps:
      - name: Determine version and if build is needed
        id: check_versions
        run: |
          MANUAL_VERSION="${{ github.event.inputs.nginx_version }}"

          if [ -n "$MANUAL_VERSION" ]; then
            echo "Manual version specified: $MANUAL_VERSION. Forcing build."
            echo "should_build=true" >> "$GITHUB_OUTPUT"
            echo "version=$MANUAL_VERSION" >> "$GITHUB_OUTPUT"
          else
            echo "No manual version specified. Detecting latest stable version..."
            LATEST_STABLE=$(curl -s https://nginx.org/download/ | \
              grep -o 'nginx-[0-9.]\+\.tar\.gz' | \
              sed -e 's/nginx-//' -e 's/\.tar\.gz//' | \
              awk -F. '$2 % 2 == 0' | \
              sort -V | \
              tail -n 1)

            if [ -z "$LATEST_STABLE" ]; then
              echo "ERROR: Failed to parse latest stable NGINX version."
              exit 1
            fi
            echo "Latest stable NGINX version is: $LATEST_STABLE"

            LATEST_RELEASE_TAG=$(curl -sf -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/releases/latest" | \
              jq -r .tag_name || true)

            if [ -z "$LATEST_RELEASE_TAG" ]; then
              echo "No previous release found. Triggering initial build."
              echo "should_build=true" >> "$GITHUB_OUTPUT"
            else
              LAST_RELEASED_VERSION=$(echo "$LATEST_RELEASE_TAG" | sed 's/^nginx-//')
              echo "Last released version is: $LAST_RELEASED_VERSION"
              if [ "$LATEST_STABLE" != "$LAST_RELEASED_VERSION" ]; then
                echo "New version detected ($LATEST_STABLE). Proceeding with build."
                echo "should_build=true" >> "$GITHUB_OUTPUT"
              else
                echo "Version $LATEST_STABLE is already the latest. Build skipped."
                echo "should_build=false" >> "$GITHUB_OUTPUT"
              fi
            fi
            echo "version=$LATEST_STABLE" >> "$GITHUB_OUTPUT"
          fi

  # This job builds the NGINX binary and the ACME module for Ubuntu
  # using a matrix strategy.
  build-ubuntu:
    name: Build for ${{ matrix.os_name }}
    needs: check-for-new-version
    if: needs.check-for-new-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest

    # Define the matrix to run this job for Ubuntu 24.04.
    strategy:
      matrix:
        include:
          - os_name: Ubuntu 24.04 (Noble Numbat)
            os_tag: '24.04'

    # Use the matrix variable to select the correct Docker container.
    container: ubuntu:${{ matrix.os_tag }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Install Build Dependencies
        run: |
          apt-get update
          # Install libssl-dev for dynamic linking against the system's OpenSSL.
          apt-get install -y --no-install-recommends \
            build-essential libclang-dev pkg-config libpcre2-dev zlib1g-dev libssl-dev \
            libxml2-dev libxslt1-dev libgd-dev libgeoip-dev libperl-dev \
            wget git curl ca-certificates jq

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Download and Build (Dynamically Linked)
        env:
          NGINX_VERSION: ${{ needs.check-for-new-version.outputs.version }}
        run: |
          wget -q http://nginx.org/download/nginx-$NGINX_VERSION.tar.gz
          tar -zxf nginx-$NGINX_VERSION.tar.gz
          git clone --depth 1 https://github.com/nginx/nginx-acme.git
          cd nginx-$NGINX_VERSION

          BUILD_PATH=$(pwd)
          CC_OPT_VALUE="-g -O2 -ffile-prefix-map=$BUILD_PATH=. -fstack-protector-strong -Wformat -Werror=format-security -fPIC"

          # Configure NGINX for a portable layout, linking against system libraries.
          # The ACME module is built as a dynamic module (`.so` file).
          ./configure \
            --with-cc-opt="$CC_OPT_VALUE" \
            --with-ld-opt='-Wl,-z,relro -Wl,-z,now -Wl,--as-needed -fPIC' \
            --prefix=.. \
            --conf-path=nginx.conf \
            --http-log-path=logs/access.log \
            --error-log-path=logs/error.log \
            --lock-path=run/nginx.lock \
            --pid-path=run/nginx.pid \
            --modules-path=modules \
            --http-client-body-temp-path=temp/body \
            --http-fastcgi-temp-path=temp/fastcgi \
            --http-proxy-temp-path=temp/proxy \
            --http-scgi-temp-path=temp/scgi \
            --http-uwsgi-temp-path=temp/uwsgi \
            --with-compat \
            --with-debug \
            --with-pcre-jit \
            --with-http_ssl_module \
            --with-http_stub_status_module \
            --with-http_realip_module \
            --with-http_auth_request_module \
            --with-http_v2_module \
            --add-dynamic-module=../nginx-acme/

          make

      - name: Package Artifacts
        env:
          NGINX_VERSION: ${{ needs.check-for-new-version.outputs.version }}
          OS_TAG: ${{ matrix.os_tag }}
        run: |
          SOURCE_DIR="nginx-$NGINX_VERSION"
          MODULE_PATH="$SOURCE_DIR/objs/ngx_http_acme_module.so"
          NGINX_BINARY_PATH="$SOURCE_DIR/objs/nginx"

          if [ ! -f "$MODULE_PATH" ] || [ ! -f "$NGINX_BINARY_PATH" ]; then
            echo "::error::Build failed! Required files were not created."
            exit 1
          fi

          PACKAGE_BASE_DIR="nginx_acme"
          mkdir -p "$PACKAGE_BASE_DIR/sbin"
          mkdir -p "$PACKAGE_BASE_DIR/modules"
          mkdir -p "$PACKAGE_BASE_DIR/vhost"
          mkdir -p "$PACKAGE_BASE_DIR/acme"
          mkdir -p "$PACKAGE_BASE_DIR/logs"
          mkdir -p "$PACKAGE_BASE_DIR/run"
          mkdir -p "$PACKAGE_BASE_DIR/temp/body"
          mkdir -p "$PACKAGE_BASE_DIR/temp/proxy"
          mkdir -p "$PACKAGE_BASE_DIR/temp/fastcgi"
          mkdir -p "$PACKAGE_BASE_DIR/temp/scgi"
          mkdir -p "$PACKAGE_BASE_DIR/temp/uwsgi"

          cp "$NGINX_BINARY_PATH" "$PACKAGE_BASE_DIR/sbin/nginx"
          cp "$MODULE_PATH" "$PACKAGE_BASE_DIR/modules/ngx_http_acme_module.so"
          cp "$SOURCE_DIR/conf/mime.types" "$PACKAGE_BASE_DIR/"

          echo -e "-----------------debug-------------------"
          pwd
          ls -alh
          echo -e "------------------end--------------------"

          cp conf/nginx.conf "$PACKAGE_BASE_DIR/nginx.conf"
          cp conf/default.conf.example "$PACKAGE_BASE_DIR/vhost/default.conf.example"
          cp nginxctl.sh "$PACKAGE_BASE_DIR/nginxctl.sh"

          chmod +x "$PACKAGE_BASE_DIR/nginxctl.sh"

          cat <<'EOF' > "$PACKAGE_BASE_DIR/README.txt"
          Usage: ./nginxctl.sh {start|stop|quit|reload|test|status}
          Commands:
            start   - Start NGINX (tests config first)
            stop    - Stop NGINX immediately (fast shutdown)
            quit    - Stop NGINX gracefully
            reload  - Reload configuration (tests config first)
            test    - Test NGINX configuration
            status  - Show NGINX process status
          EOF

          # Use the matrix variable to create a uniquely named archive.
          ARTIFACT_NAME="nginx-${NGINX_VERSION}-acme-ubuntu${OS_TAG}.tar.gz"
          tar -czf "$ARTIFACT_NAME" "$PACKAGE_BASE_DIR"

          ARTIFACT_DIR=artifact
          mkdir -p "$ARTIFACT_DIR"
          mv "$ARTIFACT_NAME" "$ARTIFACT_DIR/"
          sha256sum "$ARTIFACT_DIR/$ARTIFACT_NAME" > "$ARTIFACT_DIR/$ARTIFACT_NAME.sha256"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          # Use a unique name for the artifact to prevent conflicts between matrix jobs.
          name: nginx-package-ubuntu${{ matrix.os_tag }}
          path: artifact/

  # This job runs only after all matrix build jobs have succeeded. It collects
  # all the generated packages and publishes them to a single GitHub Release.
  create-release:
    name: Create GitHub Release
    needs: [check-for-new-version, build-ubuntu]
    if: needs.check-for-new-version.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts from build jobs
        uses: actions/download-artifact@v4
        with:
          path: ./dist
          # Use a pattern to download all artifacts produced by the matrix.
          pattern: nginx-package-*
          merge-multiple: true

      - name: List downloaded files for debugging
        run: ls -R ./dist

      - name: Prepare release content and assets
        id: prep
        run: |
          mkdir -p release-assets
          # Move all downloaded packages to the release assets directory.
          find ./dist -name "*.tar.gz" -exec mv {} ./release-assets/ \;

          echo "### SHA256 Checksums" > release-body.md
          echo '```' >> release-body.md
          # Combine all checksum files into the release body.
          find ./dist -name "*.sha256" -exec cat {} + >> release-body.md
          echo '```' >> release-body.md
          {
            echo "body<<EOF"
            cat release-body.md
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create Release and Upload All Assets
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: nginx-${{ needs.check-for-new-version.outputs.version }}
          name: NGINX ${{ needs.check-for-new-version.outputs.version }} with ACME Module Packages
          body: ${{ steps.prep.outputs.body }}
          # Use a glob pattern to upload all packaged archives.
          files: ./release-assets/*.tar.gz
